# TCK-20260129-301: Language System Analysis

**Date:** 2026-01-30  
**Status:** Deep-dive complete - Implementation plan ready

---

## üîç Root Cause Analysis

### The Problem Isn't Just "Cannot Change Profile Language"

The issue is a **systemic disconnect** between three different language concepts:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         LANGUAGE SYSTEM CHAOS                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                             ‚îÇ
‚îÇ  1. Profile.preferred_language     2. settings.gameLanguage                ‚îÇ
‚îÇ     (Stored in DB)                   (Stored in localStorage)               ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ         'en'                              'english'                         ‚îÇ
‚îÇ          ‚îÇ                                     ‚îÇ                            ‚îÇ
‚îÇ          ‚ñº                                     ‚ñº                            ‚îÇ
‚îÇ  Games.tsx DISPLAYS                 AlphabetGame.tsx USES                   ‚îÇ
‚îÇ  "Play in English"                   (but different value!)                 ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  3. settings.language                                                       ‚îÇ
‚îÇ     (UI language - not used for game)                                       ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Three Separate Issues

| Issue | Location | Impact | User Experience |
|-------|----------|--------|-----------------|
| **1. No Edit Profile** | Dashboard.tsx | HIGH | Created profile with wrong language? Delete and recreate |
| **2. Game Uses Wrong Language** | AlphabetGame.tsx | CRITICAL | Games page shows "Hindi" but game loads English |
| **3. No Visual Indicator** | Game.tsx | MEDIUM | User doesn't know which language is active |

---

## üìä Current System State

### Backend (‚úÖ Mostly Complete)

| Component | Status | Notes |
|-----------|--------|-------|
| `Profile.preferred_language` field | ‚úÖ | Stores 'en', 'hi', 'kn', 'te', 'ta' |
| `ProfileUpdate` schema | ‚úÖ | Has preferred_language field |
| `ProfileService.update()` | ‚úÖ | Can update profile |
| **API Endpoint** | ‚ùå **MISSING** | No PATCH /me/profiles/{id} endpoint |

### Frontend (‚ö†Ô∏è Broken)

| Component | Uses | Status | Problem |
|-----------|------|--------|---------|
| **Dashboard** | `preferred_language` | ‚úÖ Works | But NO EDIT functionality |
| **Games.tsx** | `preferred_language` | ‚úÖ Display | Shows language badge correctly |
| **AlphabetGame.tsx** | `settings.gameLanguage` | ‚ùå **WRONG** | Ignores profile, uses settings |
| **Settings Store** | `gameLanguage` | ‚ö†Ô∏è Confusing | Separate from profile |

### Data Flow (Current - Broken)

```
User Creates Profile
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Dashboard   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí‚îÇ  Profile Store  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí‚îÇ   Backend DB     ‚îÇ
‚îÇ               ‚îÇ     ‚îÇpreferred_language‚îÇ     ‚îÇ (stores 'en')    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                       Games.tsx DISPLAYS
                       "Play in English"
                              ‚îÇ
                              ‚ñº
                    User clicks Play
                              ‚îÇ
                              ‚ñº
                    ‚ùå AlphabetGame.tsx
                       Uses DIFFERENT
                       settings.gameLanguage
                       (might be 'hi'!)
```

---

## üéØ What Fixing TCK-20260129-301 Unlocks

### Immediate Impact

| After Fix | Before Fix |
|-----------|------------|
| Edit language without deleting profile | Delete + recreate profile |
| Game loads correct language | Game loads random language |
| Visual indicator shows active language | User confused which language |
| Progress tracked per language | Mixed progress data |

### Unblocks These Tickets

| Ticket | Why Blocked |
|--------|-------------|
| **TCK-20260130-015** | FingerNumberShow language selection needs profile editing first |
| **TCK-20260129-302** | Visual indicator needs language system to work first |
| **TCK-20260129-072** | Game should use profile language - needs this fix |
| **TCK-20260129-303** | Language as game choice - needs stable language system |

### System-Wide Benefits

```
Before:                          After:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3 Language  ‚îÇ                ‚îÇ 1 Unified   ‚îÇ
‚îÇ Systems     ‚îÇ    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí     ‚îÇ Language    ‚îÇ
‚îÇ (Confusing) ‚îÇ                ‚îÇ System      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

- profile.preferred_language   - Single source of truth
- settings.gameLanguage        - Profile language drives everything
- settings.language            - Settings UI edits profile
```

---

## üîß Implementation Plan

### Changes Required (5 Components)

| # | File | Change | Effort |
|---|------|--------|--------|
| 1 | `users.py` (backend) | Add PATCH /me/profiles/{id} endpoint | 30 min |
| 2 | `api.ts` (frontend) | Add profileApi.updateProfile() method | 15 min |
| 3 | `profileStore.ts` | Add updateProfile() action | 20 min |
| 4 | `Dashboard.tsx` | Add "Edit Profile" modal with language selector | 45 min |
| 5 | `AlphabetGame.tsx` | Use profile language instead of settings | 15 min |

### Total Effort: ~2.5 hours

---

## üìù Detailed Code Changes

### 1. Backend: Add Update Endpoint

**File:** `src/backend/app/api/v1/endpoints/users.py`

```python
@router.patch("/me/profiles/{profile_id}", response_model=Profile)
async def update_profile(
    profile_id: str,
    profile_in: ProfileUpdate,
    current_user: UserModel = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
) -> Profile:
    """Update a child's profile."""
    # Validate profile_id format
    try:
        validate_uuid(profile_id, "profile_id")
    except ValidationError as e:
        raise HTTPException(
            status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
            detail=str(e),
        )
    
    # Get profile
    profile = await ProfileService.get_by_id(db, profile_id)
    if not profile:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Profile not found",
        )
    
    # Verify profile belongs to current user
    if profile.parent_id != current_user.id:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Not enough permissions",
        )
    
    # Update profile
    updated = await ProfileService.update(db, profile, profile_in)
    return updated
```

### 2. Frontend API: Add Update Method

**File:** `src/frontend/src/services/api.ts`

```typescript
updateProfile: (profileId: string, data: Partial<{ 
  name: string; 
  age?: number; 
  preferred_language?: string 
}>) =>
  api.patch(`/users/me/profiles/${profileId}`, data),
```

### 3. Frontend Store: Add Update Action

**File:** `src/frontend/src/store/profileStore.ts`

```typescript
updateProfile: async (profileId, data) => {
  set({ isLoading: true, error: null });
  try {
    const response = await profileApi.updateProfile(profileId, data);
    set((state) => ({
      profiles: state.profiles.map(p => 
        p.id === profileId ? response.data : p
      ),
      currentProfile: state.currentProfile?.id === profileId 
        ? response.data 
        : state.currentProfile,
      isLoading: false,
    }));
  } catch (error: any) {
    set({
      error: error.response?.data?.detail || 'Failed to update profile',
      isLoading: false,
    });
  }
},
```

### 4. Dashboard: Add Edit Modal

**File:** `src/frontend/src/pages/Dashboard.tsx`

Add state:

```typescript
const [editingProfile, setEditingProfile] = useState<Profile | null>(null);
const [editName, setEditName] = useState('');
const [editLanguage, setEditLanguage] = useState('en');
```

Add edit handler:

```typescript
const handleUpdateProfile = async () => {
  if (!editingProfile) return;
  await updateProfile(editingProfile.id, {
    name: editName,
    preferred_language: editLanguage,
  });
  setEditingProfile(null);
  toast.success('Profile updated!');
};
```

### 5. AlphabetGame: Fix Language Source

**File:** `src/frontend/src/pages/AlphabetGame.tsx`

Change:

```typescript
// FROM (WRONG):
const defaultLanguage = settings.gameLanguage || 'en';

// TO (CORRECT):
const { currentProfile } = useProfileStore();
const defaultLanguage = currentProfile?.preferred_language || 'en';
```

---

## üß™ Testing Strategy

### Test Cases

| # | Test | Expected |
|---|------|----------|
| 1 | Create profile with Hindi | Profile shows 'hi' in DB |
| 2 | Edit profile to Kannada | Profile updates to 'kn' |
| 3 | Play game with Kannada profile | Game loads Kannada alphabet |
| 4 | Switch profile language | Game reloads with new alphabet |
| 5 | Visual indicator | Shows Kannada in UI |

### Regression Tests

- Existing profiles still work
- Progress tracked per language
- No breaking changes to API

---

## üìà Success Metrics

| Metric | Before | After | Target |
|--------|--------|-------|--------|
| Language change steps | 3 (delete, recreate, reconfigure) | 1 (edit) | 1 |
| Language consistency | 60% (confusing) | 100% | 100% |
| User complaints | "Wrong language" | None | None |

---

## ‚ö†Ô∏è Risks & Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| Existing settings.gameLanguage users | Medium | Migration: Sync profile language on first load |
| API change breaks mobile app | Low | Versioned API, mobile not live yet |
| Profile update race condition | Low | Optimistic UI with rollback on error |

---

## ‚úÖ Recommendation: PROCEED

**This ticket should be done FIRST because:**

1. **Foundation for all language work** - Unlocks 10+ other tickets
2. **Quick win** - 2.5 hours, high impact
3. **User-facing bug** - Currently causing confusion
4. **Low risk** - Well-understood scope, no breaking changes

**Next ticket after this:** TCK-20260130-015 (FingerNumberShow Language Selection)
